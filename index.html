<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Quiz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Modern CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --success-color: #4caf50;
            --background-color: #f7f9fc;
            --card-color: #ffffff;
            --text-color: #333333;
            --text-light: #666666;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --container-width: 960px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --button-padding-vertical: 10px;
            --button-padding-horizontal: 24px;
            --button-font-size: 1rem;
            --question-font-size: 2rem;
        }

        body[data-question-display="focus"] .question-container {
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.15), rgba(74, 111, 165, 0.15));
            border: 2px solid rgba(79, 195, 247, 0.2);
        }

        body[data-question-display="compact"] .question-container {
            padding: var(--spacing-md);
            border-radius: calc(var(--border-radius) / 2);
            font-size: 0.9em;
        }

        body[data-question-display="chalkboard"] .question-container {
            background: #1b4332;
            color: #f1faee;
            border: 2px solid rgba(241, 250, 238, 0.2);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.25);
            font-family: 'Patrick Hand', 'Segoe UI', sans-serif;
        }

        body[data-button-size="small"] {
            --button-padding-vertical: 8px;
            --button-padding-horizontal: 16px;
            --button-font-size: 0.9rem;
        }

        body[data-button-size="medium"] {
            --button-padding-vertical: 12px;
            --button-padding-horizontal: 24px;
            --button-font-size: 1rem;
        }

        body[data-button-size="large"] {
            --button-padding-vertical: 16px;
            --button-padding-horizontal: 32px;
            --button-font-size: 1.15rem;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-md);
        }

        .container {
            width: 100%;
            max-width: var(--container-width);
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: var(--spacing-lg);
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 600;
        }

        /* Custom moon emoji style for the header */
        .moon-icon {
            font-size: 1.5rem;
            margin-left: var(--spacing-sm);
            vertical-align: middle;
        }

        /* Settings Panel Styles */
        #settings-panel {
            padding: var(--spacing-lg);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .settings-section {
            margin-bottom: var(--spacing-lg);
        }

        .settings-section h3 {
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
            font-weight: 500;
        }

        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: var(--spacing-sm);
            cursor: pointer;
        }

        .timer-settings {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: rgba(79, 195, 247, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(79, 195, 247, 0.3);
        }

        .input-group {
            margin-bottom: var(--spacing-md);
        }

        .input-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .input-group input[type="number"],
        .input-group input[type="range"] {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .input-group input[type="number"]:focus,
        .input-group input[type="range"]:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }

        .slider-container {
            display: flex;
            align-items: center;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            margin-left: var(--spacing-md);
            font-weight: 600;
        }

        .btn {
            display: inline-block;
            padding: var(--button-padding-vertical) var(--button-padding-horizontal);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            text-align: center;
            font-size: var(--button-font-size);
        }

        /* Dynamic Theme Palettes */
        body[data-theme="light"] {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --background-color: #f7f9fc;
            --card-color: #ffffff;
            --text-color: #2d3142;
            --text-light: #6b778d;
        }

        body[data-theme="dark"] {
            --primary-color: #1f4068;
            --secondary-color: #16213e;
            --accent-color: #e94560;
            --background-color: #0f172a;
            --card-color: #111827;
            --text-color: #f8fafc;
            --text-light: #94a3b8;
        }

        body[data-theme="minimalis"] {
            --primary-color: #2b2d42;
            --secondary-color: #8d99ae;
            --accent-color: #ef233c;
            --background-color: #edf2f4;
            --card-color: #ffffff;
            --text-color: #2b2d42;
            --text-light: #8d99ae;
        }

        body[data-theme="ocean"] {
            --primary-color: #006994;
            --secondary-color: #003554;
            --accent-color: #00a6fb;
            --background-color: #e0f7fa;
            --card-color: #ffffff;
            --text-color: #022b3a;
            --text-light: #3c6e71;
        }

        body[data-theme="forest"] {
            --primary-color: #386641;
            --secondary-color: #2a9d8f;
            --accent-color: #f4a261;
            --background-color: #f0f7f4;
            --card-color: #ffffff;
            --text-color: #1b4332;
            --text-light: #52796f;
        }

        body[data-theme="sunset"] {
            --primary-color: #f25f5c;
            --secondary-color: #ff9f1c;
            --accent-color: #ffe066;
            --background-color: #fff5e6;
            --card-color: #ffffff;
            --text-color: #6d597a;
            --text-light: #b56576;
        }

        body[data-theme="retro"] {
            --primary-color: #ff6b6b;
            --secondary-color: #f7b801;
            --accent-color: #6a4c93;
            --background-color: #fdf0d5;
            --card-color: #ffffff;
            --text-color: #2b2d42;
            --text-light: #9a8c98;
        }

        body[data-theme="monochrome"] {
            --primary-color: #4f4f4f;
            --secondary-color: #2f2f2f;
            --accent-color: #8f8f8f;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #1c1c1c;
            --text-light: #6d6d6d;
        }

        body[data-theme="neon"] {
            --primary-color: #00f5d4;
            --secondary-color: #ff0a54;
            --accent-color: #f15bb5;
            --background-color: #050505;
            --card-color: #0f0f0f;
            --text-color: #f8f9fa;
            --text-light: #adb5bd;
        }

        body[data-theme="pastel"] {
            --primary-color: #a2d2ff;
            --secondary-color: #ffafcc;
            --accent-color: #cdb4db;
            --background-color: #fdf0f5;
            --card-color: #ffffff;
            --text-color: #5c5470;
            --text-light: #9f86c0;
        }

        body[data-theme="autumn"] {
            --primary-color: #9c6644;
            --secondary-color: #c49d78;
            --accent-color: #ef8354;
            --background-color: #fff5eb;
            --card-color: #ffffff;
            --text-color: #5a3d2b;
            --text-light: #b08968;
        }

        body[data-theme="space"] {
            --primary-color: #5a189a;
            --secondary-color: #240046;
            --accent-color: #80ffdb;
            --background-color: #03071e;
            --card-color: #0b132b;
            --text-color: #f5f3f4;
            --text-light: #adb5bd;
        }

        body[data-theme="colorful"] {
            --primary-color: #ff6f59;
            --secondary-color: #254e70;
            --accent-color: #16db93;
            --background-color: #f6f7f8;
            --card-color: #ffffff;
            --text-color: #2e294e;
            --text-light: #6c757d;
        }

        body[data-theme="cyberpunk"] {
            --primary-color: #ff007f;
            --secondary-color: #5900ff;
            --accent-color: #00f0ff;
            --background-color: #050014;
            --card-color: #0d0221;
            --text-color: #f8f9fa;
            --text-light: #9b9b9b;
        }

        body[data-theme="coffee"] {
            --primary-color: #6f4e37;
            --secondary-color: #b08968;
            --accent-color: #ddb892;
            --background-color: #f3e9dc;
            --card-color: #fff8f0;
            --text-color: #3c2f2f;
            --text-light: #8c7158;
        }

        body[data-theme="candy"] {
            --primary-color: #ff85a1;
            --secondary-color: #ffbd39;
            --accent-color: #8acb88;
            --background-color: #fff0f6;
            --card-color: #ffffff;
            --text-color: #7c3f58;
            --text-light: #d16ba5;
        }

        body[data-theme="sakura"] {
            --primary-color: #ef9a9a;
            --secondary-color: #f48fb1;
            --accent-color: #ce93d8;
            --background-color: #fff4f6;
            --card-color: #ffffff;
            --text-color: #6f2c3f;
            --text-light: #b56576;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-large {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 1.1rem;
            width: 100%;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        /* Quiz Interface Styles */
        #quiz-interface {
            padding: var(--spacing-lg);
        }

        .timer-bar-container {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .timer-bar {
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 5px;
            transition: width 1s linear;
        }

        .timer-bar.warning {
            background-color: var(--warning-color);
        }

        .timer-bar.danger {
            background-color: var(--danger-color);
        }

        .timer-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            font-weight: 600;
        }

        .question-container {
            background-color: rgba(74, 111, 165, 0.05);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .question {
            font-size: var(--question-font-size);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .question-steps {
            margin-top: var(--spacing-md);
            text-align: left;
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .question-steps ol {
            padding-left: 1.25rem;
        }

        .question-steps li {
            margin-bottom: var(--spacing-xs);
        }

        .question-note {
            display: block;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: var(--spacing-xs);
        }

        .question-expression {
            display: block;
            margin-top: var(--spacing-sm);
            font-size: calc(var(--question-font-size) * 0.9);
        }

        .answer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }

        .answer-input {
            width: 100%;
            max-width: 200px;
            padding: var(--spacing-md);
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .answer-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.2);
        }

        .division-result {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
        }

        .division-result .input-group {
            margin-bottom: 0;
        }

        .progress-info {
            margin-top: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            color: var(--text-light);
        }

        /* Results Panel Styles */
        #results-panel {
            padding: var(--spacing-lg);
        }

        .results-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: confetti-fall 3s ease-in-out infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .results-summary {
            background-color: rgba(76, 175, 80, 0.1);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .score-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: var(--spacing-sm);
        }

        .chart-container {
            margin: var(--spacing-lg) 0;
            height: 300px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .adaptive-feedback {
            background-color: rgba(79, 195, 247, 0.1);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .feedback-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .feedback-icon {
            font-size: 1.5rem;
            margin-right: var(--spacing-sm);
            color: var(--accent-color);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .action-buttons .btn {
            flex: 1;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% {
                transform: translate3d(-1px, 0, 0);
            }
            20%, 80% {
                transform: translate3d(2px, 0, 0);
            }
            30%, 50%, 70% {
                transform: translate3d(-4px, 0, 0);
            }
            40%, 60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .settings-grid,
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 0 var(--spacing-sm);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .question {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Math Quiz <span class="moon-icon">ðŸŒ™</span></h1>
        </header>
        
        <!-- Settings Panel -->
        <section id="settings-panel">
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>Select Operations</h3>
                    <div class="checkbox-container">
                        <div class="checkbox-item">
                            <input type="checkbox" id="addition" checked>
                            <label for="addition">Addition</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="subtraction">
                            <label for="subtraction">Subtraction</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="multiplication">
                            <label for="multiplication">Multiplication</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="division">
                            <label for="division">Division</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="exponentiation">
                            <label for="exponentiation">Exponentiation</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="percentage">
                            <label for="percentage">Percentage</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="pemdas">
                            <label for="pemdas">PEMDAS (Fractions &amp; Decimals)</label>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Number Range</h3>
                    <div class="input-group">
                        <label for="leftNumberLimit">Left Number Limit (0 to ...):</label>
                        <input type="number" id="leftNumberLimit" min="1" max="1000" value="10">
                    </div>
                    <div class="input-group">
                        <label for="rightNumberLimit">Right Number Limit (0 to ...):</label>
                        <input type="number" id="rightNumberLimit" min="1" max="1000" value="10">
                    </div>
                    <div class="input-group">
                        <label for="exponentValue">Exponent Value:</label>
                        <input type="number" id="exponentValue" min="1" max="10" value="2">
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="checkbox-item">
                    <input type="checkbox" id="timerEnabled">
                    <label for="timerEnabled">Enable Timer Challenge Mode</label>
                </div>
                
                <div id="timerSettings" class="timer-settings hidden">
                    <div class="input-group">
                        <label for="timerDuration">Time per Question (seconds):</label>
                        <div class="slider-container">
                            <input type="range" id="timerDuration" min="5" max="60" value="30" step="5">
                            <span class="slider-value" id="timerDurationValue">30</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Personalize Experience</h3>
                <div class="input-group">
                    <label for="themeSelector">Theme:</label>
                    <select id="themeSelector">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="minimalis">Minimalis</option>
                        <option value="ocean">Ocean</option>
                        <option value="forest">Forest</option>
                        <option value="sunset">Sunset</option>
                        <option value="retro">Retro</option>
                        <option value="monochrome">Monochrome</option>
                        <option value="neon">Neon</option>
                        <option value="pastel">Pastel</option>
                        <option value="autumn">Autumn</option>
                        <option value="space">Space</option>
                        <option value="colorful">Colorful</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="coffee">Coffee</option>
                        <option value="candy">Candy</option>
                        <option value="sakura">Sakura</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="buttonSizeSelector">Button Size:</label>
                    <select id="buttonSizeSelector">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="questionDisplaySelector">Question Display Style:</label>
                    <select id="questionDisplaySelector">
                        <option value="standard">Standard</option>
                        <option value="focus">Focus Highlight</option>
                        <option value="compact">Compact</option>
                        <option value="chalkboard">Chalkboard</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="submissionMethodSelector">Answer Submission:</label>
                    <select id="submissionMethodSelector">
                        <option value="button">Button Only</option>
                        <option value="enter">Enter Key</option>
                        <option value="both" selected>Button + Enter</option>
                        <option value="auto">Auto When Confident</option>
                    </select>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="showPemdasSteps">
                    <label for="showPemdasSteps">Show PEMDAS breakdown</label>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="soundToggle">
                    <label for="soundToggle">Enable subtle feedback sounds</label>
                </div>
            </div>
            
            <div class="input-group">
                <label for="questionCount">Number of Questions:</label>
                <input type="number" id="questionCount" min="1" max="50" value="10">
            </div>
            
            <button id="startQuizBtn" class="btn btn-large btn-success">Start Quiz</button>
        </section>
        
        <!-- Quiz Interface -->
        <section id="quiz-interface" class="hidden">
            <div id="timerContainer" class="hidden">
                <div class="timer-info">
                    <span id="timeLeft">30s left</span>
                    <span id="questionProgress">Question 1 of 10</span>
                </div>
                <div class="timer-bar-container">
                    <div id="timerBar" class="timer-bar" style="width: 100%;"></div>
                </div>
            </div>
            
            <div class="question-container">
                <div class="question" id="question">8 + 5 = ?</div>
                <div class="question-steps hidden" id="questionSteps"></div>
            </div>
            
            <div class="answer-container">
                <input type="text" id="answer" class="answer-input" placeholder="Enter answer (e.g., 3, 2.5, 1/2)">

                <div id="divisionResults" class="division-result hidden">
                    <div class="input-group">
                        <label for="quotient">Quotient:</label>
                        <input type="number" id="quotient" class="answer-input">
                    </div>
                    <div class="input-group">
                        <label for="remainder">Remainder:</label>
                        <input type="number" id="remainder" class="answer-input">
                    </div>
                </div>

                <button id="submitAnswerBtn" class="btn btn-large">Submit Answer</button>
                <div id="submissionHint" class="progress-info"></div>
            </div>
            
            <div class="progress-info">
                <span id="currentScoreDisplay">Score: 0 / 0</span>
            </div>
        </section>
        
        <!-- Results Panel -->
        <section id="results-panel" class="hidden">
            <div class="results-header">
                <h2>Congratulations! ðŸ¥³</h2>
                <p>You've completed the quiz!</p>
            </div>
            
            <div class="results-summary">
                <div class="score-display" id="finalScore">8 / 10</div>
                <p>Correct Answers</p>
            </div>
            
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgTimeValue">6.2s</div>
                    <div class="stat-label">Average Time per Question</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accuracyValue">80%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fastestTimeValue">2.8s</div>
                    <div class="stat-label">Fastest Answer</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="improvedByValue">+5%</div>
                    <div class="stat-label">Improved from Last Quiz</div>
                </div>
            </div>
            
            <div class="adaptive-feedback">
                <div class="feedback-header">
                    <i class="fas fa-robot feedback-icon"></i>
                    <h3>Adaptive Learning Feedback</h3>
                </div>
                <p id="adaptiveFeedback">
                    Based on your performance, you're doing well with addition problems but may need more practice with multiplication. 
                    Your next quiz will have slightly more challenging multiplication problems to help you improve.
                </p>
            </div>
            
            <div class="action-buttons">
                <button id="restartQuizBtn" class="btn">Start New Quiz</button>
                <button id="adaptiveQuizBtn" class="btn btn-success">Try Adaptive Quiz</button>
            </div>
        </section>
    </div>

    <script>
        // Store user data and quiz state
        const quizState = {
            operations: [],
            currentQuestion: 0,
            totalQuestions: 0,
            score: 0,
            timerEnabled: false,
            timerDuration: 30,
            timerInterval: null,
            startTime: 0,
            questions: [],
            answers: [],
            timeTaken: [],
            isCorrect: [],
            operationTypes: [],
            difficulty: 'normal', // 'easy', 'normal', 'hard'
            theme: 'light',
            buttonSize: 'medium',
            questionDisplay: 'standard',
            submissionMethod: 'both',
            showPemdasSteps: false,
            soundEnabled: false,
            recommendedDifficulty: 'normal'
        };

        // DOM Elements
        const settingsPanel = document.getElementById('settings-panel');
        const quizInterface = document.getElementById('quiz-interface');
        const resultsPanel = document.getElementById('results-panel');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const adaptiveQuizBtn = document.getElementById('adaptiveQuizBtn');
        const timerEnabledCheckbox = document.getElementById('timerEnabled');
        const timerSettings = document.getElementById('timerSettings');
        const timerContainer = document.getElementById('timerContainer');
        const timerBar = document.getElementById('timerBar');
        const timeLeft = document.getElementById('timeLeft');
        const questionProgress = document.getElementById('questionProgress');
        const timerDurationSlider = document.getElementById('timerDuration');
        const timerDurationValue = document.getElementById('timerDurationValue');
        const questionElement = document.getElementById('question');
        const questionStepsElement = document.getElementById('questionSteps');
        const answerInput = document.getElementById('answer');
        const divisionResults = document.getElementById('divisionResults');
        const quotientInput = document.getElementById('quotient');
        const remainderInput = document.getElementById('remainder');
        const currentScoreDisplay = document.getElementById('currentScoreDisplay');
        const finalScore = document.getElementById('finalScore');
        const avgTimeValue = document.getElementById('avgTimeValue');
        const accuracyValue = document.getElementById('accuracyValue');
        const fastestTimeValue = document.getElementById('fastestTimeValue');
        const improvedByValue = document.getElementById('improvedByValue');
        const adaptiveFeedback = document.getElementById('adaptiveFeedback');
        const submissionHint = document.getElementById('submissionHint');
        const themeSelector = document.getElementById('themeSelector');
        const buttonSizeSelector = document.getElementById('buttonSizeSelector');
        const submissionMethodSelector = document.getElementById('submissionMethodSelector');
        const questionDisplaySelector = document.getElementById('questionDisplaySelector');
        const showPemdasStepsCheckbox = document.getElementById('showPemdasSteps');
        const soundToggle = document.getElementById('soundToggle');

        // Operation checkbox references
        const operationCheckboxes = {
            addition: document.getElementById('addition'),
            subtraction: document.getElementById('subtraction'),
            multiplication: document.getElementById('multiplication'),
            division: document.getElementById('division'),
            exponentiation: document.getElementById('exponentiation'),
            percentage: document.getElementById('percentage'),
            pemdas: document.getElementById('pemdas')
        };

        let performanceChartInstance = null;
        let autoSubmitTimeout = null;
        let audioContext = null;

        // Initialize application
        function init() {
            // Set up event listeners
            timerEnabledCheckbox.addEventListener('change', toggleTimerSettings);
            timerDurationSlider.addEventListener('input', updateTimerDurationDisplay);
            startQuizBtn.addEventListener('click', startQuiz);
            submitAnswerBtn.addEventListener('click', checkAnswer);
            restartQuizBtn.addEventListener('click', resetQuiz);
            adaptiveQuizBtn.addEventListener('click', startAdaptiveQuiz);
            answerInput.addEventListener('keydown', handleAnswerKeyDown);
            answerInput.addEventListener('input', handleAnswerInput);
            quotientInput.addEventListener('keydown', handleAnswerKeyDown);
            remainderInput.addEventListener('keydown', handleAnswerKeyDown);
            quotientInput.addEventListener('input', handleAnswerInput);
            remainderInput.addEventListener('input', handleAnswerInput);

            themeSelector.addEventListener('change', () => {
                applyTheme(themeSelector.value);
                saveUserPreferences();
            });
            buttonSizeSelector.addEventListener('change', () => {
                applyButtonSize(buttonSizeSelector.value);
                saveUserPreferences();
            });
            questionDisplaySelector.addEventListener('change', () => {
                applyQuestionDisplay(questionDisplaySelector.value);
                saveUserPreferences();
                displayQuestion();
            });
            submissionMethodSelector.addEventListener('change', () => {
                applySubmissionMethod(submissionMethodSelector.value);
                saveUserPreferences();
            });
            showPemdasStepsCheckbox.addEventListener('change', () => {
                quizState.showPemdasSteps = showPemdasStepsCheckbox.checked;
                saveUserPreferences();
                displayQuestion();
            });
            soundToggle.addEventListener('change', () => {
                quizState.soundEnabled = soundToggle.checked;
                if (quizState.soundEnabled) {
                    initAudioContext();
                }
                saveUserPreferences();
            });

            // Load saved preferences if available
            loadUserPreferences();

            // Initial UI setup
            updateTimerDurationDisplay();
            applyTheme(quizState.theme);
            applyButtonSize(quizState.buttonSize);
            applyQuestionDisplay(quizState.questionDisplay);
            applySubmissionMethod(quizState.submissionMethod);
        }

        // Toggle timer settings visibility
        function toggleTimerSettings() {
            timerSettings.classList.toggle('hidden', !timerEnabledCheckbox.checked);
        }

        // Update timer duration display
        function updateTimerDurationDisplay() {
            timerDurationValue.textContent = timerDurationSlider.value;
        }

        function applyTheme(theme) {
            quizState.theme = theme;
            document.body.setAttribute('data-theme', theme);
        }

        function applyButtonSize(size) {
            quizState.buttonSize = size;
            document.body.setAttribute('data-button-size', size);
        }

        function applyQuestionDisplay(style) {
            quizState.questionDisplay = style;
            document.body.setAttribute('data-question-display', style);
        }

        function applySubmissionMethod(method) {
            quizState.submissionMethod = method;
            submitAnswerBtn.classList.toggle('hidden', method === 'enter' || method === 'auto');
            submitAnswerBtn.disabled = method === 'enter' || method === 'auto';

            if (method === 'button') {
                submissionHint.textContent = 'Click the button to submit your answer.';
            } else if (method === 'enter') {
                submissionHint.textContent = 'Press Enter to submit your answer instantly.';
            } else if (method === 'both') {
                submitAnswerBtn.disabled = false;
                submissionHint.textContent = 'Use Enter or click the button when you are ready.';
            } else if (method === 'auto') {
                submissionHint.textContent = 'Auto-check enabled. Answers submit when they appear correct.';
            }
        }

        function handleAnswerKeyDown(event) {
            if ((quizState.submissionMethod === 'enter' || quizState.submissionMethod === 'both') && event.key === 'Enter') {
                event.preventDefault();
                checkAnswer();
            }
        }

        function handleAnswerInput() {
            if (quizState.submissionMethod === 'auto') {
                scheduleAutoSubmit();
            }
        }

        function scheduleAutoSubmit() {
            if (autoSubmitTimeout) {
                clearTimeout(autoSubmitTimeout);
            }

            autoSubmitTimeout = setTimeout(() => {
                attemptAutoSubmit();
            }, 400);
        }

        function attemptAutoSubmit() {
            const currentQ = quizState.questions[quizState.currentQuestion];
            if (!currentQ) return;

            if (currentQ.operationType === 'division') {
                const quotient = parseInt(quotientInput.value, 10);
                const remainder = parseInt(remainderInput.value, 10);
                if (isNaN(quotient) || isNaN(remainder)) return;

                if (quotient === currentQ.answer[0] && remainder === currentQ.answer[1]) {
                    checkAnswer();
                }
            } else {
                const parsed = parseUserInput(answerInput.value);
                if (parsed === null) return;

                let tolerance = 0;
                if (currentQ.operationType === 'percentage' || currentQ.operationType === 'pemdas') {
                    tolerance = 0.01;
                }

                if (Math.abs(parsed - currentQ.answer) <= tolerance) {
                    checkAnswer();
                }
            }
        }

        function parseUserInput(rawValue) {
            if (typeof rawValue !== 'string') return null;

            const trimmed = rawValue.trim();
            if (!trimmed) return null;

            const fractionMatch = trimmed.match(/^(-?\d+)\s*\/\s*(-?\d+)$/);
            if (fractionMatch) {
                const numerator = parseFloat(fractionMatch[1]);
                const denominator = parseFloat(fractionMatch[2]);
                if (denominator === 0) return null;
                return numerator / denominator;
            }

            const normalized = trimmed.replace(',', '.');
            const parsed = Number(normalized);
            return Number.isFinite(parsed) ? parsed : null;
        }

        function formatNumber(value) {
            if (!Number.isFinite(value)) return value;
            const rounded = Math.round((value + Number.EPSILON) * 1000) / 1000;
            return parseFloat(rounded.toFixed(3)).toString();
        }

        function initAudioContext() {
            if (!audioContext) {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (AudioContextClass) {
                    audioContext = new AudioContextClass();
                }
            }
        }

        function playFeedbackSound(type) {
            if (!quizState.soundEnabled) return;
            if (!audioContext) {
                initAudioContext();
            }
            if (!audioContext) return;

            const frequencies = {
                correct: 880,
                incorrect: 220,
                timeup: 180
            };

            const duration = 0.18;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.value = frequencies[type] || 440;
            gainNode.gain.setValueAtTime(0.0001, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Load user preferences from localStorage
        function loadUserPreferences() {
            const savedPreferences = localStorage.getItem('mathQuizPreferences');
            if (savedPreferences) {
                const preferences = JSON.parse(savedPreferences);
                
                // Restore operation selections
                for (const op in operationCheckboxes) {
                    if (preferences.operations && preferences.operations[op] !== undefined) {
                        operationCheckboxes[op].checked = preferences.operations[op];
                    }
                }
                
                // Restore other settings
                if (preferences.leftNumberLimit) 
                    document.getElementById('leftNumberLimit').value = preferences.leftNumberLimit;
                if (preferences.rightNumberLimit) 
                    document.getElementById('rightNumberLimit').value = preferences.rightNumberLimit;
                if (preferences.exponentValue) 
                    document.getElementById('exponentValue').value = preferences.exponentValue;
                if (preferences.questionCount) 
                    document.getElementById('questionCount').value = preferences.questionCount;
                if (preferences.timerEnabled !== undefined) {
                    timerEnabledCheckbox.checked = preferences.timerEnabled;
                    toggleTimerSettings();
                }
                if (preferences.timerDuration) {
                    timerDurationSlider.value = preferences.timerDuration;
                    updateTimerDurationDisplay();
                }
                if (preferences.theme) {
                    themeSelector.value = preferences.theme;
                    applyTheme(preferences.theme);
                }
                if (preferences.buttonSize) {
                    buttonSizeSelector.value = preferences.buttonSize;
                    applyButtonSize(preferences.buttonSize);
                }
                if (preferences.questionDisplay) {
                    questionDisplaySelector.value = preferences.questionDisplay;
                    applyQuestionDisplay(preferences.questionDisplay);
                }
                if (preferences.submissionMethod) {
                    submissionMethodSelector.value = preferences.submissionMethod;
                    applySubmissionMethod(preferences.submissionMethod);
                }
                if (preferences.showPemdasSteps !== undefined) {
                    showPemdasStepsCheckbox.checked = preferences.showPemdasSteps;
                    quizState.showPemdasSteps = preferences.showPemdasSteps;
                }
                if (preferences.soundEnabled !== undefined) {
                    soundToggle.checked = preferences.soundEnabled;
                    quizState.soundEnabled = preferences.soundEnabled;
                    if (quizState.soundEnabled) {
                        initAudioContext();
                    }
                }
            }
        }

        // Save user preferences to localStorage
        function saveUserPreferences() {
            const preferences = {
                operations: {},
                leftNumberLimit: parseInt(document.getElementById('leftNumberLimit').value),
                rightNumberLimit: parseInt(document.getElementById('rightNumberLimit').value),
                exponentValue: parseInt(document.getElementById('exponentValue').value),
                questionCount: parseInt(document.getElementById('questionCount').value),
                timerEnabled: timerEnabledCheckbox.checked,
                timerDuration: parseInt(timerDurationSlider.value),
                theme: quizState.theme,
                buttonSize: quizState.buttonSize,
                questionDisplay: quizState.questionDisplay,
                submissionMethod: quizState.submissionMethod,
                showPemdasSteps: quizState.showPemdasSteps,
                soundEnabled: quizState.soundEnabled
            };
            
            // Save operation selections
            for (const op in operationCheckboxes) {
                preferences.operations[op] = operationCheckboxes[op].checked;
            }
            
            localStorage.setItem('mathQuizPreferences', JSON.stringify(preferences));
        }

        // Start the quiz
        function startQuiz() {
            // Get selected operations
            quizState.operations = [];
            for (const op in operationCheckboxes) {
                if (operationCheckboxes[op].checked) {
                    quizState.operations.push(op);
                }
            }
            
            // Validate selections
            if (quizState.operations.length === 0) {
                alert('Please select at least one operation type');
                return;
            }
            
            // Get quiz settings
            const leftNumberLimit = parseInt(document.getElementById('leftNumberLimit').value);
            const rightNumberLimit = parseInt(document.getElementById('rightNumberLimit').value);
            quizState.totalQuestions = parseInt(document.getElementById('questionCount').value);
            quizState.timerEnabled = timerEnabledCheckbox.checked;
            quizState.timerDuration = parseInt(timerDurationSlider.value);
            quizState.theme = themeSelector.value;
            quizState.buttonSize = buttonSizeSelector.value;
            quizState.questionDisplay = questionDisplaySelector.value;
            quizState.submissionMethod = submissionMethodSelector.value;
            quizState.showPemdasSteps = showPemdasStepsCheckbox.checked;
            quizState.soundEnabled = soundToggle.checked;

            applyTheme(quizState.theme);
            applyButtonSize(quizState.buttonSize);
            applyQuestionDisplay(quizState.questionDisplay);
            applySubmissionMethod(quizState.submissionMethod);

            // Save preferences
            saveUserPreferences();
            
            // Generate questions
            generateQuestions(leftNumberLimit, rightNumberLimit);
            
            // Reset quiz state
            quizState.currentQuestion = 0;
            quizState.score = 0;
            quizState.answers = new Array(quizState.totalQuestions).fill(null);
            quizState.timeTaken = new Array(quizState.totalQuestions).fill(0);
            quizState.isCorrect = new Array(quizState.totalQuestions).fill(false);
            
            // Switch to quiz interface
            settingsPanel.classList.add('hidden');
            quizInterface.classList.remove('hidden');
            
            // Display first question
            displayQuestion();
            
            // Focus on answer input
            answerInput.focus();
        }

        // Generate questions for the quiz
        function applyMathOperation(a, b, operator) {
            switch (operator) {
                case '+':
                    return a + b;
                case '-':
                    return a - b;
                case '*':
                    return a * b;
                case '/':
                    return a / b;
                default:
                    return b;
            }
        }

        function generatePemdasProblem(difficulty) {
            const fractionOptions = [
                { display: '1/2', eval: '(1/2)', value: 1 / 2 },
                { display: '3/4', eval: '(3/4)', value: 3 / 4 },
                { display: '2/5', eval: '(2/5)', value: 2 / 5 },
                { display: '5/8', eval: '(5/8)', value: 5 / 8 },
                { display: '7/10', eval: '(7/10)', value: 7 / 10 },
                { display: '9/10', eval: '(9/10)', value: 9 / 10 }
            ];

            const decimalOptions = {
                easy: [0.4, 0.5, 0.6, 0.75, 1.2, 1.5],
                normal: [0.25, 0.5, 0.75, 1.25, 1.5, 2.4, 2.75],
                hard: [0.2, 0.45, 0.65, 1.75, 2.5, 3.25, 4.5]
            };

            const operationPool = [
                { symbol: '+', display: '+', label: 'penjumlahan' },
                { symbol: '-', display: 'âˆ’', label: 'pengurangan' },
                { symbol: '*', display: 'Ã—', label: 'perkalian' },
                { symbol: '/', display: 'Ã·', label: 'pembagian' }
            ];

            const availableDecimals = decimalOptions[difficulty] || decimalOptions.normal;

            function randomItem(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            function getComponent(forceFraction = false) {
                if (forceFraction) {
                    return { ...randomItem(fractionOptions) };
                }
                const useFraction = Math.random() > 0.5;
                if (useFraction) {
                    return { ...randomItem(fractionOptions) };
                }
                const decimalValue = randomItem(availableDecimals);
                return {
                    display: formatNumber(decimalValue),
                    eval: decimalValue.toString(),
                    value: decimalValue
                };
            }

            const firstComponent = getComponent(true); // guarantee fraction
            const secondDecimalValue = randomItem(availableDecimals);
            const second = {
                display: formatNumber(secondDecimalValue),
                eval: secondDecimalValue.toString(),
                value: secondDecimalValue
            };
            const third = getComponent();

            const components = [firstComponent, second, third];
            const template = Math.random() > 0.5 ? 'left' : 'right';
            const operations = [];

            while (operations.length < 2) {
                const candidate = randomItem(operationPool);
                if (difficulty === 'easy' && candidate.symbol === '/') continue;
                operations.push(candidate);
            }

            let expressionDisplay = '';
            let evaluationExpression = '';
            const steps = [];
            let intermediate = 0;

            if (template === 'left') {
                expressionDisplay = `(${components[0].display} ${operations[0].display} ${components[1].display}) ${operations[1].display} ${components[2].display}`;
                evaluationExpression = `(${components[0].eval || components[0].display} ${operations[0].symbol} ${components[1].eval || components[1].display}) ${operations[1].symbol} ${components[2].eval || components[2].display}`;
                intermediate = applyMathOperation(components[0].value, components[1].value, operations[0].symbol);
                steps.push(`Hitung bagian dalam kurung terlebih dahulu: ${components[0].display} ${operations[0].display} ${components[1].display} = ${formatNumber(intermediate)}`);
                const finalValue = applyMathOperation(intermediate, components[2].value, operations[1].symbol);
                steps.push(`Kemudian ${operations[1].label} dengan hasil sebelumnya: ${formatNumber(intermediate)} ${operations[1].display} ${components[2].display} = ${formatNumber(finalValue)}`);
                intermediate = finalValue;
            } else {
                expressionDisplay = `${components[0].display} ${operations[0].display} (${components[1].display} ${operations[1].display} ${components[2].display})`;
                evaluationExpression = `${components[0].eval || components[0].display} ${operations[0].symbol} (${components[1].eval || components[1].display} ${operations[1].symbol} ${components[2].eval || components[2].display})`;
                intermediate = applyMathOperation(components[1].value, components[2].value, operations[1].symbol);
                steps.push(`Selesaikan kurung terlebih dahulu: ${components[1].display} ${operations[1].display} ${components[2].display} = ${formatNumber(intermediate)}`);
                const finalValue = applyMathOperation(components[0].value, intermediate, operations[0].symbol);
                steps.push(`Lanjutkan dengan ${operations[0].label}: ${components[0].display} ${operations[0].display} ${formatNumber(intermediate)} = ${formatNumber(finalValue)}`);
                intermediate = finalValue;
            }

            // Evaluate final answer using Function constructor for reliability
            const safeExpression = evaluationExpression.replace(/Ã·/g, '/').replace(/Ã—/g, '*');
            let computedAnswer;
            try {
                computedAnswer = new Function(`return ${safeExpression};`)();
            } catch (error) {
                computedAnswer = intermediate;
            }

            const finalAnswer = Math.round(computedAnswer * 100) / 100;

            return {
                question: `${expressionDisplay} = ?`,
                questionHtml: `<div>Selesaikan menggunakan aturan PEMDAS:</div><div class="question-expression"><strong>${expressionDisplay}</strong></div><span class="question-note">Gunakan dua angka di belakang koma jika diperlukan.</span>`,
                answer: finalAnswer,
                operationType: 'pemdas',
                steps
            };
        }

        function generateQuestions(leftLimit, rightLimit) {
            const exponentValue = parseInt(document.getElementById('exponentValue').value);
            quizState.questions = [];
            quizState.operationTypes = [];

            for (let i = 0; i < quizState.totalQuestions; i++) {
                const operationType = quizState.operations[Math.floor(Math.random() * quizState.operations.length)];
                quizState.operationTypes.push(operationType);

                let leftNum, rightNum;
                let questionData = null;

                // Generate numbers based on difficulty (for adaptive quizzes)
                if (quizState.difficulty === 'easy') {
                    leftNum = Math.floor(Math.random() * (leftLimit / 2)) + 1;
                    rightNum = Math.floor(Math.random() * (rightLimit / 2)) + 1;
                } else if (quizState.difficulty === 'hard') {
                    leftNum = Math.floor(Math.random() * leftLimit) + leftLimit/2;
                    rightNum = Math.floor(Math.random() * rightLimit) + rightLimit/2;
                } else { // normal difficulty
                    leftNum = Math.floor(Math.random() * leftLimit) + 1;
                    rightNum = Math.floor(Math.random() * rightLimit) + 1;
                }
                
                // Special case for division to ensure clean division for beginners in easy mode
                if (operationType === 'division' && quizState.difficulty === 'easy') {
                    rightNum = Math.floor(Math.random() * 10) + 1;
                    leftNum = rightNum * (Math.floor(Math.random() * 10) + 1);
                }
                
                // Generate question and answer based on operation type
                switch (operationType) {
                    case 'addition':
                        questionData = {
                            question: `${leftNum} + ${rightNum} = ?`,
                            answer: leftNum + rightNum,
                            operationType,
                            leftNum,
                            rightNum
                        };
                        break;
                    case 'subtraction':
                        if (quizState.difficulty === 'easy' && leftNum < rightNum) {
                            [leftNum, rightNum] = [rightNum, leftNum];
                        }
                        questionData = {
                            question: `${leftNum} - ${rightNum} = ?`,
                            answer: leftNum - rightNum,
                            operationType,
                            leftNum,
                            rightNum
                        };
                        break;
                    case 'multiplication':
                        questionData = {
                            question: `${leftNum} Ã— ${rightNum} = ?`,
                            answer: leftNum * rightNum,
                            operationType,
                            leftNum,
                            rightNum
                        };
                        break;
                    case 'division':
                        if (rightNum === 0) rightNum = 1;
                        questionData = {
                            question: `${leftNum} Ã· ${rightNum} = ?`,
                            answer: [Math.floor(leftNum / rightNum), leftNum % rightNum],
                            operationType,
                            leftNum,
                            rightNum
                        };
                        break;
                    case 'exponentiation':
                        rightNum = Math.min(rightNum, exponentValue);
                        questionData = {
                            question: `${leftNum} ^ ${rightNum} = ?`,
                            answer: Math.pow(leftNum, rightNum),
                            operationType,
                            leftNum,
                            rightNum
                        };
                        break;
                    case 'percentage':
                        questionData = {
                            question: `${leftNum}% of ${rightNum} = ?`,
                            answer: (leftNum / 100) * rightNum,
                            operationType,
                            leftNum,
                            rightNum
                        };
                        break;
                    case 'pemdas':
                        questionData = generatePemdasProblem(quizState.difficulty);
                        break;
                }

                if (questionData) {
                    quizState.questions.push(questionData);
                }
            }
        }

        // Display the current question
        function displayQuestion() {
            const currentQ = quizState.questions[quizState.currentQuestion];
            if (autoSubmitTimeout) {
                clearTimeout(autoSubmitTimeout);
                autoSubmitTimeout = null;
            }

            applySubmissionMethod(quizState.submissionMethod);

            const questionContent = currentQ.questionHtml || currentQ.question;
            questionElement.innerHTML = questionContent;

            if (quizState.showPemdasSteps && currentQ.steps && currentQ.steps.length > 0) {
                questionStepsElement.classList.remove('hidden');
                questionStepsElement.innerHTML = `<ol>${currentQ.steps.map(step => `<li>${step}</li>`).join('')}</ol>`;
            } else {
                questionStepsElement.classList.add('hidden');
                questionStepsElement.innerHTML = '';
            }

            // Update progress display
            questionProgress.textContent = `Question ${quizState.currentQuestion + 1} of ${quizState.totalQuestions}`;
            currentScoreDisplay.textContent = `Score: ${quizState.score} / ${quizState.currentQuestion}`;

            // Show/hide division results inputs
            if (currentQ.operationType === 'division') {
                divisionResults.classList.remove('hidden');
                answerInput.classList.add('hidden');
                quotientInput.value = '';
                remainderInput.value = '';
                quotientInput.focus();
                if (quizState.submissionMethod === 'auto') {
                    submissionHint.textContent = 'Fill quotient and remainder. Submission triggers when both are correct.';
                }
            } else {
                divisionResults.classList.add('hidden');
                answerInput.classList.remove('hidden');
                answerInput.value = '';
                answerInput.focus();
            }

            // Reset and start timer if enabled
            if (quizState.timerEnabled) {
                timerContainer.classList.remove('hidden');
                timerBar.style.width = '100%';
                timerBar.className = 'timer-bar';
                timeLeft.textContent = `${quizState.timerDuration}s left`;
                
                // Clear previous timer if exists
                if (quizState.timerInterval) {
                    clearInterval(quizState.timerInterval);
                }
                
                // Start new timer
                quizState.startTime = Date.now();
                startTimer();
            } else {
                timerContainer.classList.add('hidden');
                quizState.startTime = Date.now();
            }
        }

        // Start the timer for current question
        function startTimer() {
            let timeRemaining = quizState.timerDuration;
            
            quizState.timerInterval = setInterval(() => {
                timeRemaining -= 0.1; // Update every 100ms
                const percentage = (timeRemaining / quizState.timerDuration) * 100;
                
                // Update timer bar
                timerBar.style.width = `${percentage}%`;
                timeLeft.textContent = `${Math.ceil(timeRemaining)}s left`;
                
                // Add warning classes
                if (percentage <= 25) {
                    timerBar.className = 'timer-bar danger pulse';
                } else if (percentage <= 50) {
                    timerBar.className = 'timer-bar warning';
                }
                
                // Time's up
                if (timeRemaining <= 0) {
                    clearInterval(quizState.timerInterval);
                    handleTimeUp();
                }
            }, 100);
        }

        // Handle when time is up
        function handleTimeUp() {
            // Record time taken as max time
            quizState.timeTaken[quizState.currentQuestion] = quizState.timerDuration;

            playFeedbackSound('timeup');

            // Move to next question
            moveToNextQuestion();
        }

        // Check the user's answer
        function checkAnswer() {
            const currentQ = quizState.questions[quizState.currentQuestion];
            let userAnswer, isCorrect = false;

            // Stop timer
            if (quizState.timerInterval) {
                clearInterval(quizState.timerInterval);
            }

            // Calculate time taken
            const timeTaken = (Date.now() - quizState.startTime) / 1000;
            quizState.timeTaken[quizState.currentQuestion] = Math.min(timeTaken, quizState.timerDuration);

            // Get and validate user's answer
            if (currentQ.operationType === 'division') {
                const quotient = parseInt(quotientInput.value, 10);
                const remainder = parseInt(remainderInput.value, 10);

                if (isNaN(quotient) || isNaN(remainder)) {
                    showAnswerError();
                    return;
                }

                userAnswer = [quotient, remainder];
                isCorrect = userAnswer[0] === currentQ.answer[0] && userAnswer[1] === currentQ.answer[1];
                quizState.answers[quizState.currentQuestion] = userAnswer;
            } else {
                userAnswer = parseUserInput(answerInput.value);

                if (userAnswer === null) {
                    showAnswerError();
                    return;
                }

                // For operations with decimals, allow a small margin of error due to rounding
                if (currentQ.operationType === 'percentage' || currentQ.operationType === 'pemdas') {
                    isCorrect = Math.abs(userAnswer - currentQ.answer) < 0.01;
                } else {
                    isCorrect = userAnswer === currentQ.answer;
                }

                quizState.answers[quizState.currentQuestion] = userAnswer;
            }

            // Update score and record correctness
            if (isCorrect) {
                quizState.score++;
                playFeedbackSound('correct');
            } else {
                playFeedbackSound('incorrect');
            }
            quizState.isCorrect[quizState.currentQuestion] = isCorrect;

            // Move to next question or show results
            moveToNextQuestion();
        }

        // Show error for invalid answer
        function showAnswerError() {
            // Shake the input for visual feedback
            if (quizState.questions[quizState.currentQuestion].operationType === 'division') {
                quotientInput.classList.add('shake');
                remainderInput.classList.add('shake');
                setTimeout(() => {
                    quotientInput.classList.remove('shake');
                    remainderInput.classList.remove('shake');
                }, 500);
            } else {
                answerInput.classList.add('shake');
                setTimeout(() => {
                    answerInput.classList.remove('shake');
                }, 500);
            }
        }

        // Move to the next question or finish the quiz
        function moveToNextQuestion() {
            quizState.currentQuestion++;
            
            if (quizState.currentQuestion < quizState.totalQuestions) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        // Show quiz results
        function showResults() {
            quizInterface.classList.add('hidden');
            resultsPanel.classList.remove('hidden');
            
            // Display final score
            finalScore.textContent = `${quizState.score} / ${quizState.totalQuestions}`;
            
            // Calculate statistics
            const avgTime = quizState.timeTaken.reduce((a, b) => a + b, 0) / quizState.totalQuestions;
            const fastestTime = Math.min(...quizState.timeTaken);
            const accuracy = (quizState.score / quizState.totalQuestions) * 100;
            
            // Display statistics
            avgTimeValue.textContent = `${avgTime.toFixed(1)}s`;
            fastestTimeValue.textContent = `${fastestTime.toFixed(1)}s`;
            accuracyValue.textContent = `${accuracy.toFixed(0)}%`;
            
            // Compare with previous results
            const prevResults = loadPreviousResults();
            let improvement = 0;
            
            if (prevResults && prevResults.length > 0) {
                const lastResult = prevResults[prevResults.length - 1];
                improvement = accuracy - lastResult.accuracy;
                improvedByValue.textContent = `${improvement > 0 ? '+' : ''}${improvement.toFixed(0)}%`;
            } else {
                improvedByValue.textContent = 'First Quiz';
            }
            
            // Save current results
            saveQuizResults({
                date: new Date().toISOString(),
                score: quizState.score,
                totalQuestions: quizState.totalQuestions,
                accuracy: accuracy,
                avgTime: avgTime,
                operations: quizState.operationTypes,
                isCorrect: quizState.isCorrect,
                timeTaken: quizState.timeTaken,
                difficulty: quizState.difficulty
            });
            
            // Generate adaptive feedback
            generateAdaptiveFeedback();
            
            // Create performance charts
            createPerformanceChart();
            
            // Create celebratory confetti effect
            if (quizState.score > quizState.totalQuestions / 2) {
                createConfetti();
            }
        }

        // Create confetti animation
        function createConfetti() {
            const container = document.querySelector('.container');
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.opacity = Math.random() + 0.5;
                confetti.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(confetti);
            }
            
            // Remove confetti after animation completes
            setTimeout(() => {
                const confettiElements = document.querySelectorAll('.confetti');
                confettiElements.forEach(el => el.remove());
            }, 6000);
        }

        // Create performance chart using Chart.js
        function createPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Prepare data for the chart
            const labels = [];
            const timeData = [];
            const correctnessData = [];
            
            for (let i = 0; i < quizState.totalQuestions; i++) {
                labels.push(`Q${i + 1}`);
                timeData.push(quizState.timeTaken[i]);
                correctnessData.push(quizState.isCorrect[i] ? 1 : 0);
            }
            
            // Create chart
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
            }

            performanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Time Taken (seconds)',
                            data: timeData,
                            backgroundColor: 'rgba(79, 195, 247, 0.5)',
                            borderColor: 'rgba(79, 195, 247, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Correct Answer',
                            data: correctnessData,
                            type: 'line',
                            backgroundColor: 'rgba(76, 175, 80, 0.5)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(76, 175, 80, 1)',
                            pointRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 1,
                            position: 'right',
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value === 1 ? 'Correct' : 'Incorrect';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate adaptive feedback based on performance
        function generateAdaptiveFeedback() {
            // Analyze performance by operation type
            const operationPerformance = {};
            const operationTime = {};
            
            for (let i = 0; i < quizState.totalQuestions; i++) {
                const opType = quizState.operationTypes[i];
                
                if (!operationPerformance[opType]) {
                    operationPerformance[opType] = {
                        correct: 0,
                        total: 0
                    };
                    operationTime[opType] = [];
                }
                
                operationPerformance[opType].total++;
                if (quizState.isCorrect[i]) {
                    operationPerformance[opType].correct++;
                }
                
                operationTime[opType].push(quizState.timeTaken[i]);
            }
            
            // Identify strengths and weaknesses
            const strengths = [];
            const weaknesses = [];
            
            for (const op in operationPerformance) {
                const perf = operationPerformance[op];
                const accuracy = (perf.correct / perf.total) * 100;
                const avgTime = operationTime[op].reduce((a, b) => a + b, 0) / operationTime[op].length;
                
                if (perf.total > 0) {
                    if (accuracy >= 80) {
                        strengths.push({ operation: getOperationName(op), accuracy, avgTime });
                    } else if (accuracy < 60) {
                        weaknesses.push({ operation: getOperationName(op), accuracy, avgTime });
                    }
                }
            }
            
            // Sort by accuracy
            strengths.sort((a, b) => b.accuracy - a.accuracy);
            weaknesses.sort((a, b) => a.accuracy - b.accuracy);
            
            // Generate feedback text
            let feedback = '';
            
            if (quizState.score === quizState.totalQuestions) {
                feedback = `Perfect score! Amazing job! You've mastered all the operations in this quiz level.`;
            } else if (quizState.score >= quizState.totalQuestions * 0.8) {
                feedback = `Great work! You're showing strong skills across most operations.`;
            } else if (quizState.score >= quizState.totalQuestions * 0.5) {
                feedback = `Good effort! With some targeted practice, you can improve your score even more.`;
            } else {
                feedback = `You're making progress! Let's focus on building your fundamental skills.`;
            }
            
            feedback += ' ';
            
            if (strengths.length > 0) {
                feedback += `You're particularly strong with ${strengths[0].operation}`;
                if (strengths.length > 1) {
                    feedback += ` and ${strengths[1].operation}`;
                }
                feedback += '. ';
            }
            
            if (weaknesses.length > 0) {
                feedback += `You might benefit from more practice with ${weaknesses[0].operation}`;
                if (weaknesses.length > 1) {
                    feedback += ` and ${weaknesses[1].operation}`;
                }
                feedback += '. ';
            }
            
            // Add adaptive difficulty recommendation
            const overallAccuracy = (quizState.score / quizState.totalQuestions) * 100;
            
            if (overallAccuracy >= 85) {
                feedback += `For your next quiz, we recommend trying a more challenging level to push your math skills further.`;
                quizState.recommendedDifficulty = 'hard';
            } else if (overallAccuracy <= 40) {
                feedback += `For your next quiz, we recommend starting with a slightly easier level to build up your skills and confidence.`;
                quizState.recommendedDifficulty = 'easy';
            } else {
                feedback += `Your current difficulty level seems appropriate. Keep practicing to improve your accuracy and speed.`;
                quizState.recommendedDifficulty = 'normal';
            }
            
            adaptiveFeedback.textContent = feedback;
        }

        // Get friendly name for operation type
        function getOperationName(operation) {
            const names = {
                'addition': 'addition',
                'subtraction': 'subtraction',
                'multiplication': 'multiplication',
                'division': 'division',
                'exponentiation': 'exponents',
                'percentage': 'percentages'
            };
            
            return names[operation] || operation;
        }

        // Load previous quiz results from localStorage
        function loadPreviousResults() {
            const savedResults = localStorage.getItem('mathQuizResults');
            return savedResults ? JSON.parse(savedResults) : [];
        }

        // Save quiz results to localStorage
        function saveQuizResults(results) {
            const previousResults = loadPreviousResults();
            previousResults.push(results);
            
            // Keep only the last 20 results to prevent localStorage from getting too large
            if (previousResults.length > 20) {
                previousResults.shift();
            }
            
            localStorage.setItem('mathQuizResults', JSON.stringify(previousResults));
        }

        // Start adaptive quiz based on previous performance
        function startAdaptiveQuiz() {
            // Set difficulty based on recommendation
            quizState.difficulty = quizState.recommendedDifficulty || 'normal';
            
            // Analyze previous results to determine which operations to focus on
            const previousResults = loadPreviousResults();
            
            if (previousResults.length > 0) {
                // Get operations with lowest accuracy from recent quizzes
                const operationAccuracy = {};
                let totalOperations = 0;
                
                // Consider only the most recent 3 quizzes
                const recentResults = previousResults.slice(-3);
                
                recentResults.forEach(result => {
                    for (let i = 0; i < result.operations.length; i++) {
                        const operation = result.operations[i];
                        if (!operationAccuracy[operation]) {
                            operationAccuracy[operation] = {
                                correct: 0,
                                total: 0
                            };
                        }
                        
                        operationAccuracy[operation].total++;
                        totalOperations++;
                        
                        if (result.isCorrect[i]) {
                            operationAccuracy[operation].correct++;
                        }
                    }
                });
                
                // Calculate accuracy percentages
                for (const op in operationAccuracy) {
                    operationAccuracy[op].accuracy = 
                        (operationAccuracy[op].correct / operationAccuracy[op].total) * 100;
                }
                
                // Sort operations by accuracy (lowest first)
                const sortedOperations = Object.keys(operationAccuracy).sort(
                    (a, b) => operationAccuracy[a].accuracy - operationAccuracy[b].accuracy
                );
                
                // Select operations to focus on (lower accuracy gets more weight)
                // Ensure at least 3 operations if available
                const selectedOps = new Set();
                
                // First add all operations with accuracy below 70%
                sortedOperations.forEach(op => {
                    if (operationAccuracy[op].accuracy < 70) {
                        selectedOps.add(op);
                    }
                });
                
                // Then add remaining operations if we have less than 3
                let i = 0;
                while (selectedOps.size < 3 && i < sortedOperations.length) {
                    selectedOps.add(sortedOperations[i]);
                    i++;
                }
                
                // Check all operation checkboxes that should be included
                for (const op in operationCheckboxes) {
                    operationCheckboxes[op].checked = selectedOps.has(op);
                }
                
                // If none were selected (e.g., no previous data for that operation), default to all
                if (selectedOps.size === 0) {
                    for (const op in operationCheckboxes) {
                        operationCheckboxes[op].checked = true;
                    }
                }
            }
            
            // Reset UI and return to settings
            resetQuiz();
        }

        // Reset quiz to beginning
        function resetQuiz() {
            // Clear any timers
            if (quizState.timerInterval) {
                clearInterval(quizState.timerInterval);
            }
            if (autoSubmitTimeout) {
                clearTimeout(autoSubmitTimeout);
                autoSubmitTimeout = null;
            }

            // Reset UI
            resultsPanel.classList.add('hidden');
            quizInterface.classList.add('hidden');
            settingsPanel.classList.remove('hidden');
            
            // Clear confetti
            const confettiElements = document.querySelectorAll('.confetti');
            confettiElements.forEach(el => el.remove());
            
            // Reset state
            quizState.difficulty = 'normal';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
